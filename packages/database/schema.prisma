generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                  String                @id @default(cuid())
  name                String
  slug                String                @unique
  logo_url            String?
  website             String?
  created_at          DateTime              @default(now())
  updated_at          DateTime              @updatedAt
  email               String?
  phone               String?
  plan                String                @default("free")
  subscription_status String                @default("active")
  audit_logs          AuditLog[]
  leads               Lead[]
  messages            Message[]
  settings            OrganizationSettings?
  projects            Project[]
  users               User[]

  @@index([slug])
}

model OrganizationSettings {
  id                   String       @id @default(cuid())
  organization_id      String       @unique
  default_currency_id  String?
  allowed_currency_ids String[]     @default([])
  allow_bulk_updates   Boolean      @default(true)
  allow_csv_import     Boolean      @default(true)
  require_approval     Boolean      @default(false)
  crm_enabled          Boolean      @default(false)
  crm_type             String?
  crm_api_key          String?
  crm_webhook_url      String?
  crm_sync_direction   String?      @default("one_way")
  custom_settings      Json?        @default("{}")
  created_at           DateTime     @default(now())
  updated_at           DateTime     @updatedAt
  organization         Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
}

model User {
  id              String       @id @default(cuid())
  email           String
  password_hash   String
  first_name      String?
  last_name       String?
  avatar_url      String?
  role            UserRole     @default(USER)
  is_active       Boolean      @default(true)
  email_verified  Boolean      @default(false)
  last_login      DateTime?
  organization_id String
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  audit_logs      AuditLog[]
  assigned_leads  Lead[]       @relation("AssignedToUser")
  messages        Message[]
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([email, organization_id])
  @@index([organization_id])
  @@index([role])
  @@index([is_active])
}

model Currency {
  id                   String   @id @default(cuid())
  code                 String   @unique
  name                 String
  symbol               String
  decimal_places       Int      @default(2)
  is_active            Boolean  @default(true)
  exchange_rate_to_usd Float?
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt
  units                Unit[]

  @@index([code])
  @@index([is_active])
}

model Project {
  id              String        @id @default(cuid())
  name            String
  description     String?
  status          ProjectStatus @default(DRAFT)
  address         String?
  latitude        Float?
  longitude       Float?
  thumbnail_url   String?
  matterport_url  String?
  featured_image  String?
  settings        Json          @default("{\"color\": \"#1a73e8\", \"visibility\": \"private\"}")
  organization_id String
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
  archived_at     DateTime?
  audit_logs      AuditLog[]
  leads           Lead[]
  messages        Message[]
  organization    Organization  @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  units           Unit[]

  @@index([organization_id])
  @@index([status])
  @@index([created_at])
}

model Unit {
  id                  String     @id @default(cuid())
  sku                 String
  name                String?
  description         String?
  price               Decimal    @db.Decimal(18, 2)
  area_sqm            Float?
  bedrooms            Int?
  bathrooms           Float?
  image_url           String?
  floor_plan_url      String?
  project_id          String
  created_at          DateTime   @default(now())
  updated_at          DateTime   @updatedAt
  cost_price          Decimal?   @db.Decimal(18, 2)
  currency_id         String
  discount_percentage Decimal?   @db.Decimal(5, 2)
  features            Json?      @default("{}")
  floor               Int?
  list_price          Decimal?   @db.Decimal(18, 2)
  reserved_by_id      String?
  reserved_until      DateTime?
  sale_price          Decimal?   @db.Decimal(18, 2)
  sold_at             DateTime?
  sold_to_id          String?
  unit_type           UnitType   @default(APARTMENT)
  status              UnitStatus @default(AVAILABLE)
  audit_logs          AuditLog[]
  interested_leads    Lead[]
  currency            Currency   @relation(fields: [currency_id], references: [id])
  project             Project    @relation(fields: [project_id], references: [id], onDelete: Cascade)
  reserved_by         Lead?      @relation("ReservedUnits", fields: [reserved_by_id], references: [id])
  sold_to             Lead?      @relation("SoldUnits", fields: [sold_to_id], references: [id])

  @@unique([sku, project_id])
  @@index([project_id])
  @@index([currency_id])
  @@index([status])
  @@index([unit_type])
}

model Lead {
  id              String       @id @default(cuid())
  name            String
  email           String
  phone           String?
  stage           LeadStage    @default(NEW)
  source          String?
  notes           String?
  assigned_to_id  String?
  project_id      String
  unit_id         String?
  organization_id String
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  last_contacted  DateTime?
  converted_at    DateTime?
  audit_logs      AuditLog[]
  assigned_to     User?        @relation("AssignedToUser", fields: [assigned_to_id], references: [id])
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  project         Project      @relation(fields: [project_id], references: [id], onDelete: Cascade)
  unit            Unit?        @relation(fields: [unit_id], references: [id])
  messages        Message[]
  reserved_units  Unit[]       @relation("ReservedUnits")
  sold_units      Unit[]       @relation("SoldUnits")

  @@index([organization_id])
  @@index([project_id])
  @@index([stage])
  @@index([assigned_to_id])
  @@index([email])
}

model Message {
  id              String       @id @default(cuid())
  type            MessageType  @default(TEXT)
  content         String
  user_id         String?
  lead_id         String?
  project_id      String?
  organization_id String
  attachment_url  String?
  metadata        Json?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  lead            Lead?        @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user            User?        @relation(fields: [user_id], references: [id])

  @@index([organization_id])
  @@index([lead_id])
  @@index([project_id])
  @@index([created_at])
}

model AuditLog {
  id              String       @id @default(cuid())
  action          AuditAction
  entity_type     String
  entity_id       String
  changes         Json?
  old_values      Json?
  new_values      Json?
  ip_address      String?
  user_agent      String?
  user_id         String?
  organization_id String
  project_id      String?
  lead_id         String?
  unit_id         String?
  created_at      DateTime     @default(now())
  lead            Lead?        @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  project         Project?     @relation(fields: [project_id], references: [id], onDelete: Cascade)
  unit            Unit?        @relation(fields: [unit_id], references: [id], onDelete: Cascade)
  user            User?        @relation(fields: [user_id], references: [id])

  @@index([organization_id])
  @@index([action])
  @@index([entity_type])
  @@index([user_id])
  @@index([created_at])
}

model Integration {
  id              String   @id @default(cuid())
  name            String
  type            String
  is_active       Boolean  @default(true)
  api_key         String
  webhook_url     String?
  config          Json     @default("{}")
  organization_id String
  created_at      DateTime @default(now())

  @@index([organization_id])
}

model ApiKey {
  id              String    @id @default(cuid())
  name            String
  key             String    @unique
  secret          String
  last_used_at    DateTime?
  expires_at      DateTime?
  is_active       Boolean   @default(true)
  user_id         String
  organization_id String
  created_at      DateTime  @default(now())

  @@index([organization_id])
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
  USER
  VIEWER
  SUPER_ADMIN
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DRAFT
  COMPLETED
}

enum LeadStage {
  NEW
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  READ
  EXPORT
  IMPORT
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM_NOTIFICATION
}

enum UnitType {
  APARTMENT
  HOUSE
  COMMERCIAL
  LAND
  OFFICE
  PARKING
  STORAGE
}

enum UnitStatus {
  AVAILABLE
  RESERVED
  SOLD
  UNAVAILABLE
}
